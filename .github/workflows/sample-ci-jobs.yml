name: sample-ci-jobs

on:
  push:
    branches: [ jobs ]

jobs:
  get-aws-password:
    runs-on: self-hosted
    outputs:
      ecr_pwd: ${{ steps.step1.outputs.ecr_pwd }}
    steps:
      - id: step1
        run: |
          ECR_PWD=`aws ecr get-login-password --region us-east-1` 
          echo "::set-output name=ecr_pwd::$ECR_PWD"
  build:
    runs-on: self-hosted
    needs: get-aws-password
    steps:
      - uses: actions/checkout@v2
      - uses: actions/cache@v1
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('./pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        working-directory: .
        run: mvn clean install

      - name: Build docker image
        uses: docker://docker:dind
        with:
          args: build . -t ${{ secrets.AWS_ECR_REGISTRY }}/sample-jobs:v1
    
  docker_push:
    runs-on: self-hosted
    needs: [build,get-aws-password]
    container:
      image: 475383224204.dkr.ecr.us-east-1.amazonaws.com/step-image-docker:latest
      credentials:
        username: AWS
        password: ${{ needs.get-aws-password.outputs.ecr_pwd }}
    steps:
      - name: Publish docker image
        run: docker push ${{ secrets.AWS_ECR_REGISTRY }}/sample-jobs:v1